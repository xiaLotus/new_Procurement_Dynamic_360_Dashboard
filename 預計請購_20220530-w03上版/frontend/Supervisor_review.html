<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>長官審核頁面</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        [v-cloak] {
            display: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-approved {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .table-wrapper {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        
        .table-container {
            flex: 1;
            overflow: auto;
        }
        
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: #1e40af;
            color: white;
            z-index: 10;
            white-space: nowrap;
        }
        
        .row-selected {
            background-color: #dbeafe !important;
        }
        
        .hover-row:hover {
            background-color: #f3f4f6;
        }
        
        .content-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .bg-green-50 {
            background-color: #f0fdf4;
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .break-words {
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.5;
        }
        
        /* 備註欄位樣式 */
        .remark-display {
            font-size: 12px;
            line-height: 1.5;
            max-height: 80px;
            overflow-y: auto;
            padding: 4px;
        }
    </style>
</head>
<body class="h-full bg-gray-50">
    <div id="app" v-cloak>
        <!-- Header -->
        <div class="bg-blue-700 text-white shadow-lg flex-shrink-0">
            <div class="px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <i class="fas fa-clipboard-check text-3xl"></i>
                        <div>
                            <h1 class="text-2xl font-bold">長官審核系統</h1>
                            <p class="text-blue-200 text-sm">請購申請審核管理（已開單的不需再審核）</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm">待審核件數</div>
                        <div class="text-3xl font-bold">{{ pendingItems.length }}</div>
                        <div class="text-xs text-blue-200 mt-1">未開單且待確認</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Filter Tabs -->
            <div class="bg-white shadow-md flex-shrink-0">
                <div class="flex border-b">
                    <button 
                        @click="currentTab = 'pending'"
                        :class="currentTab === 'pending' ? 'border-b-2 border-blue-700 text-blue-700' : 'text-gray-600'"
                        class="px-6 py-3 font-medium hover:text-blue-700 transition">
                        <i class="fas fa-clock mr-2"></i>
                        待審核 ({{ pendingItems.length }})
                    </button>
                    <button 
                        @click="currentTab = 'approved'"
                        :class="currentTab === 'approved' ? 'border-b-2 border-blue-700 text-blue-700' : 'text-gray-600'"
                        class="px-6 py-3 font-medium hover:text-blue-700 transition">
                        <i class="fas fa-check-circle mr-2"></i>
                        已確認 ({{ approvedItems.length }})
                    </button>
                    <button 
                        @click="currentTab = 'rejected'"
                        :class="currentTab === 'rejected' ? 'border-b-2 border-blue-700 text-blue-700' : 'text-gray-600'"
                        class="px-6 py-3 font-medium hover:text-blue-700 transition">
                        <i class="fas fa-times-circle mr-2"></i>
                        已退回 ({{ rejectedItems.length }})
                    </button>
                    <button 
                        @click="currentTab = 'all'"
                        :class="currentTab === 'all' ? 'border-b-2 border-blue-700 text-blue-700' : 'text-gray-600'"
                        class="px-6 py-3 font-medium hover:text-blue-700 transition">
                        <i class="fas fa-list mr-2"></i>
                        全部 ({{ allFilteredItems.length }})
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-white border-b shadow-sm px-4 py-3 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button 
                            @click="selectAll"
                            v-if="currentTab === 'pending'"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
                            <i class="fas fa-check-square mr-2"></i>
                            全選
                        </button>
                        <button 
                            @click="clearSelection"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">
                            <i class="fas fa-square mr-2"></i>
                            取消全選
                        </button>
                        <span class="text-gray-600 text-sm">
                            已選擇: <strong class="text-blue-700">{{ selectedIds.length }}</strong> 筆
                        </span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button 
                            @click="approveSelected"
                            :disabled="selectedIds.length === 0"
                            :class="selectedIds.length === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-600'"
                            class="px-6 py-2 bg-green-500 text-white rounded-lg transition text-sm">
                            <i class="fas fa-check mr-2"></i>
                            批次確認 ({{ selectedIds.length }})
                        </button>
                        <button 
                            @click="rejectSelected"
                            :disabled="selectedIds.length === 0"
                            :class="selectedIds.length === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-600'"
                            class="px-6 py-2 bg-red-500 text-white rounded-lg transition text-sm">
                            <i class="fas fa-times mr-2"></i>
                            批次退回 ({{ selectedIds.length }})
                        </button>
                        <button 
                            @click="loadData"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>
                            重新整理
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-wrapper">
                <div class="bg-white rounded-lg shadow-md overflow-hidden h-full flex flex-col">
                    <div class="table-container">
                        <table class="w-full">
                            <thead class="sticky-header">
                                <tr>
                                    <th v-if="currentTab === 'pending'" class="px-3 py-3 text-center" style="width: 40px;">
                                        <input type="checkbox" @change="toggleSelectAll" :checked="isAllSelected" class="w-4 h-4">
                                    </th>
                                    <th class="px-2 py-3 text-center" style="width: 50px;">#</th>
                                    <th class="px-3 py-3 text-center" style="width: 100px;">長官確認</th>
                                    <th class="px-3 py-3 text-center" style="width: 100px;">WBS</th>
                                    <th class="px-3 py-3 text-center" style="width: 80px;">請購順序</th>
                                    <th class="px-3 py-3 text-left" style="width: 100px;">需求者</th>
                                    <th class="px-3 py-3 text-left" style="min-width: 200px;">請購項目</th>
                                    <th class="px-3 py-3 text-left" style="min-width: 200px;">需求原因</th>
                                    <th class="px-3 py-3 text-right" style="width: 110px;">總金額</th>
                                    <th class="px-3 py-3 text-center" style="width: 100px;">需求日</th>
                                    <th class="px-3 py-3 text-center" style="width: 120px;">進度追蹤</th>
                                    <th class="px-3 py-3 text-left" style="min-width: 300px;">報告路徑</th>
                                    <th class="px-3 py-3 text-left" style="width: 150px;">合作廠商</th>
                                    <th class="px-3 py-3 text-left" style="min-width: 250px;">備註</th>
                                    <!-- 操作欄：待審核和已退回都顯示 -->
                                    <th v-if="currentTab === 'pending' || currentTab === 'rejected'" class="px-3 py-3 text-center" style="width: 120px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(item, index) in displayItems" 
                                    :key="item.Id"
                                    :class="{
                                        'row-selected': selectedIds.includes(item.Id), 
                                        'hover-row': true,
                                        'bg-green-50': item['ePR No.'] && item['ePR No.'].trim() !== ''
                                    }"
                                    class="border-b">
                                    <td v-if="currentTab === 'pending'" class="px-3 py-2 text-center">
                                        <input 
                                            type="checkbox" 
                                            :value="item.Id"
                                            v-model="selectedIds"
                                            class="w-4 h-4">
                                    </td>
                                    <td class="px-2 py-2 text-center font-medium text-gray-600 text-sm">{{ index + 1 }}</td>
                                    <td class="px-3 py-2 text-center">
                                        <span v-if="item['ePR No.'] && item['ePR No.'].trim() !== ''" class="status-badge bg-blue-100 text-blue-800">
                                            <i class="fas fa-check-circle mr-1"></i>
                                            已開單
                                        </span>
                                        <span v-else :class="getStatusClass(item['長官確認'])" class="status-badge">
                                            {{ getStatusText(item['長官確認']) }}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-center text-sm">
                                        {{ item['WBS'] || '-' }}
                                    </td>
                                    <td class="px-3 py-2 text-center text-sm">
                                        <span :class="item['請購順序'] === '2' ? 'text-red-600 font-bold' : 'text-gray-600'">
                                            {{ item['請購順序'] === '2' ? '急件' : '一般' }}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-sm">{{ item['需求者'] || '-' }}</td>
                                    <td class="px-3 py-2">
                                        <div class="text-xs break-words" style="max-width: 300px; white-space: normal;">
                                            {{ item['請購項目'] || '-' }}
                                        </div>
                                    </td>
                                    <td class="px-3 py-2">
                                        <div class="text-xs break-words" style="max-width: 300px; white-space: normal;">
                                            {{ item['需求原因'] || '-' }}
                                        </div>
                                    </td>
                                    <td class="px-3 py-2 text-right font-medium text-sm">
                                        {{ formatMoney(item['總金額']) }}
                                    </td>
                                    <td class="px-3 py-2 text-center text-xs">
                                        {{ formatDate(item['需求日']) }}
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <a v-if="item['進度追蹤超連結']" 
                                           :href="item['進度追蹤超連結']" 
                                           target="_blank"
                                           class="text-blue-600 hover:text-blue-800 underline text-xs">
                                            <i class="fas fa-external-link-alt mr-1"></i>
                                            {{ item['ePR No.'] || '查看' }}
                                        </a>
                                        <span v-else class="text-gray-400 text-xs">待開單</span>
                                    </td>
                                    <td class="px-3 py-2">
                                        <div class="text-xs text-gray-700 break-all" style="max-width: 400px;">
                                            {{ item['報告路徑'] || '-' }}
                                        </div>
                                    </td>
                                    <td class="px-3 py-2">
                                        <div class="content-cell text-xs" :title="item['合作廠商']">
                                            {{ item['合作廠商'] || '-' }}
                                        </div>
                                    </td>
                                    <!-- 備註欄位（只顯示，不可編輯）-->
                                    <td class="px-3 py-2">
                                        <div class="remark-display" :class="item['備註'] ? 'text-red-600' : 'text-gray-400'">
                                            {{ item['備註'] || '-' }}
                                        </div>
                                    </td>
                                    <!-- 操作欄 -->
                                    <td v-if="currentTab === 'pending'" class="px-3 py-2 text-center">
                                        <div class="flex items-center justify-center space-x-1">
                                            <button 
                                                @click="approveSingle(item.Id)"
                                                class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button 
                                                @click="rejectSingle(item.Id)"
                                                class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <!-- 已退回的操作欄：清空備註並改為V -->
                                    <td v-if="currentTab === 'rejected'" class="px-3 py-2 text-center">
                                        <button 
                                            @click="clearRemarkAndApprove(item.Id)"
                                            class="px-3 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600 transition"
                                            title="清空備註並確認">
                                            <i class="fas fa-redo mr-1"></i>
                                            處理完成
                                        </button>
                                    </td>
                                </tr>
                                <tr v-if="displayItems.length === 0">
                                    <td :colspan="currentTab === 'pending' || currentTab === 'rejected' ? 15 : 14" class="px-4 py-8 text-center text-gray-500">
                                        <i class="fas fa-inbox text-4xl mb-2"></i>
                                        <div>目前沒有資料</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../static/js/func/supervisor_review.js"></script>
</body>
</html>