<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç‰©æ–™æ”¶è²¨å–®ä¸Šå‚³èˆ‡RTé‡‘é¡è‡ªå‹•æ›´æ–°ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div id="app" class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-50">

    <!-- ä¸»å…§å®¹ -->
    <div class="w-full max-w-none px-6 py-8">
      <div class="bg-white/90 backdrop-blur-sm rounded-2xl border border-gray-200 shadow-lg overflow-hidden">
        <div class="p-8">
          
        <!-- æ¨™é¡Œåˆ—ï¼šè¿”å› + æ¨™é¡Œ + Rule èªªæ˜ -->
        <h1 class="mb-6 flex items-center justify-center gap-4 text-gray-800 font-bold text-[20px] leading-none">
          <!-- è¿”å›æŒ‰éˆ• -->
          <button
            @click="goeRTDashboard"
            class="flex items-center gap-1 px-3 py-1.5 h-9 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white text-sm font-semibold rounded-full shadow transition-transform hover:scale-105"
            title="è¿”å›ä¸Šä¸€é "
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            è¿”å›
          </button>

          <!-- æ¨™é¡Œ + icon -->
          <span class="flex items-center gap-2 leading-none">
            <i class="fas fa-sync-alt text-lg"></i>
            ç‰©æ–™æ”¶è²¨å–®ä¸Šå‚³èˆ‡RTé‡‘é¡è‡ªå‹•æ›´æ–°ç³»çµ±
          </span>

          <!-- Rule èªªæ˜æŒ‰éˆ• -->
          <button 
            @click="showRuleExplanation" 
            class="px-3 py-1.5 h-9 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-full transition-colors flex items-center gap-1"
            title="æŸ¥çœ‹ä½¿ç”¨èªªæ˜"
          >
            <i class="fas fa-info-circle"></i>
            Rule èªªæ˜
          </button>
        </h1>

          <!-- æ‹–æ›³ / é»æ“Šä¸Šå‚³å€ -->
          <div
            v-if="!currentResult"
            @drop="handleDrop"
            @dragover.prevent="isDragging = true"
            @dragleave.prevent="isDragging = false"
            @click="$refs.fileInput.click()"
            :class="[
              'relative border-3 border-dashed rounded-xl p-12 text-center cursor-pointer transition-all duration-300',
              isDragging
                ? 'border-blue-400 bg-blue-100/50 scale-102'
                : 'border-gray-300 bg-gray-50/50 hover:border-blue-400/70 hover:bg-blue-50/50'
            ]"
          >
            <input
              ref="fileInput"
              type="file"
              @change="handleFileSelect"
              accept=".mhtml,.mht"
              class="hidden"
            />
            <div class="space-y-4">
              <div class="mx-auto w-20 h-20 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center animate-pulse">
                <i class="fas fa-cloud-upload-alt text-3xl text-white"></i>
              </div>
              <div>
                <p class="text-xl font-bold text-gray-800">æ‹–æ›³ MHTML æª”æ¡ˆåˆ°é€™è£¡</p>
                <p class="text-gray-600 mt-2">ä¸Šå‚³å¾Œå°‡è‡ªå‹•èˆ‡ eRTç¸½è¡¨å…§çš„ PO NO. æ¯”å°</p>
                <p class="text-sm text-gray-500 mt-2">åªæ”¯æ´ .mhtml æ ¼å¼</p>
              </div>
            </div>
          </div>

          <!-- è™•ç†ä¸­ç‹€æ…‹ -->
          <div v-if="isProcessing" class="mt-8 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
            <p class="text-gray-700 mt-4">æ­£åœ¨è™•ç†æª”æ¡ˆä¸¦é€²è¡Œæ¯”å°...</p>
          </div>

          <!-- è§£æçµæœèˆ‡æ¯”å° -->
          <div v-if="currentResult && !isProcessing" class="space-y-6">
            
            <!-- å¦‚æœæ²’æœ‰æœ‰æ•ˆæ•¸æ“šï¼Œé¡¯ç¤ºè­¦å‘Š -->
            <div v-if="!hasValidData" class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-yellow-400 mb-2">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>æª”æ¡ˆè§£æç•°å¸¸</strong>
                  </p>
                  <p class="text-sm text-yellow-300">
                    æª”æ¡ˆå·²ä¸Šå‚³ä½†æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¡¨æ ¼æ•¸æ“šï¼Œå»ºè­°æ¸…ç†ä¸¦é‡æ–°ä¸Šå‚³æ­£ç¢ºçš„æª”æ¡ˆã€‚
                  </p>
                </div>
                <button
                  @click="forceCleanupAndReset"
                  class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm transition flex items-center"
                >
                  <i class="fas fa-broom mr-2"></i>
                  ç«‹å³æ¸…ç†
                </button>
              </div>
            </div>
            
            <!-- æª”æ¡ˆè³‡è¨Š -->
            <div class="bg-gray-100/80 rounded-lg p-4 border border-gray-200">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-file mr-2"></i>
                    {{ currentResult.original_filename }}
                  </h3>
                  <p class="text-sm text-gray-600 mt-1">
                    ä¸Šå‚³æ™‚é–“: {{ new Date(currentResult.upload_time).toLocaleString() }}
                  </p>
                </div>
                <div class="flex space-x-2">
                  <button
                    @click="forceCleanupAndReset"
                    class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm transition"
                    title="æ¸…ç†æ•¸æ“š"
                  >
                    <i class="fas fa-trash mr-1"></i>
                    æ¸…ç†
                  </button>
                  <button
                    @click="resetUpload"
                    class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm transition"
                  >
                    <i class="fas fa-redo mr-2"></i>
                    é‡æ–°ä¸Šå‚³
                  </button>
                </div>
              </div>
            </div>

            <!-- å®Œæ•´è¡¨æ ¼ -->
            <div v-if="currentResult.gridview_data" class="bg-gray-100/80 rounded-lg p-6 border border-gray-200">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-table mr-2"></i>
                è¡¨æ ¼è³‡æ–™
              </h3>
              
              <!-- è¡¨æ ¼ -->
              <div class="overflow-x-auto bg-white rounded-lg border border-gray-200">
                <table class="w-full text-sm table-auto min-w-max">
                  <thead>
                    <tr class="bg-blue-50 border-b border-gray-200">
                      <th
                        v-for="(header, idx) in currentResult.gridview_data.headers"
                        :key="idx"
                        class="text-left py-3 px-3 text-gray-700 font-medium whitespace-nowrap"
                      >
                        <div class="flex flex-col">
                          <span>{{ header.zh || header.full }}</span>
                          <span v-if="header.en" class="text-xs text-gray-500">{{ header.en }}</span>
                        </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      v-for="(row, rowIdx) in currentResult.gridview_data.rows"
                      :key="rowIdx"
                      class="border-b border-gray-100 hover:bg-gray-50"
                    >
                      <td
                        v-for="(cell, cellIdx) in row.raw_data"
                        :key="cellIdx"
                        class="py-2 px-3 text-gray-700 whitespace-nowrap"
                      >
                        {{ cell.value || '-' }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

                          <!-- æ¯”å°çµæœ -->
            <div v-if="currentResult.comparison_result && !currentResult.comparison_result.error" 
                 class="bg-gray-100/80 rounded-lg p-6 border border-gray-200">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-check-double mr-2"></i>
                æ¯”å°çµæœ
              </h3>
              
              <!-- éƒ¨åˆ†åŒ¹é…è­¦å‘Šæç¤º -->
              <div v-if="hasPartialMatch" class="bg-orange-100 border border-orange-300 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                  <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-orange-600 text-xl"></i>
                  </div>
                  <div class="ml-3 flex-1">
                    <h4 class="text-orange-800 font-semibold mb-2">
                      âš ï¸ ç™¼ç¾ PO è™Ÿç¢¼å·®ç•°
                    </h4>
                    <div class="text-orange-700 text-sm space-y-1">
                      <p><strong>åŒ¹é…æƒ…æ³ï¼š</strong> {{ currentResult.comparison_result.summary.matched_count }} ç­†åŒ¹é…ï¼Œ{{ currentResult.comparison_result.summary.unmatched_count }} ç­†æœªåŒ¹é…</p>
                      <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
                      <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>MHTML ä¸­çš„ PO è™Ÿç¢¼èˆ‡ eRTç¸½è¡¨ ä¸­çš„ä¸å®Œå…¨ä¸€è‡´</li>
                        <li>éƒ¨åˆ† PO å¯èƒ½å·²è¢«ä¿®æ”¹æˆ–æ›´æ–°</li>
                        <li>å­˜åœ¨é‡è¤‡æˆ–ç›¸ä¼¼çš„ PO è™Ÿç¢¼</li>
                      </ul>
                      <div class="mt-3 p-3 bg-orange-50 rounded border border-orange-200">
                        <p class="text-orange-800 font-medium">
                          <i class="fas fa-lightbulb mr-1"></i>
                          å»ºè­°ï¼šè«‹æª¢æŸ¥æœªåŒ¹é…çš„é …ç›®ï¼Œç¢ºèª PO è™Ÿç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–è¯ç¹«ç›¸é—œäººå“¡ç¢ºèªè³‡æ–™ä¸€è‡´æ€§ã€‚
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- çµ±è¨ˆæ‘˜è¦ -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-500/10 rounded-lg p-3 border border-blue-300">
                  <p class="text-blue-600 text-sm">ç¸½é …ç›®æ•¸</p>
                  <p class="text-xl font-bold text-gray-800">{{ currentResult.comparison_result.summary.total_items }}</p>
                </div>
                <div class="bg-green-500/10 rounded-lg p-3 border border-green-300">
                  <p class="text-green-600 text-sm">eRTç¸½è¡¨ PO NO. åŒ¹é…</p>
                  <p class="text-xl font-bold text-gray-800">{{ currentResult.comparison_result.summary.matched_count }}</p>
                </div>
                <div class="bg-yellow-500/10 rounded-lg p-3 border border-yellow-300">
                  <p class="text-yellow-600 text-sm">æœªåŒ¹é…</p>
                  <p class="text-xl font-bold text-gray-800">{{ currentResult.comparison_result.summary.unmatched_count }}</p>
                </div>
                <div class="bg-purple-500/10 rounded-lg p-3 border border-purple-300">
                  <p class="text-purple-600 text-sm">ç¸½é‡‘é¡</p>
                  <p class="text-xl font-bold text-gray-800">
                    {{ formatCurrency(currentResult.comparison_result.summary.total_amount) }}
                  </p>
                </div>
              </div>

              <!-- RT é‡‘é¡è¨ˆç®—è¡¨ -->
              <div class="bg-white rounded-lg overflow-hidden mb-4 border border-gray-200">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead>
                      <tr class="bg-blue-50 border-b border-gray-200">
                        <th class="text-left py-3 px-4 text-gray-700">PO No.</th>
                        <th class="text-left py-3 px-4 text-gray-700">å“å</th>
                        <th class="text-center py-3 px-4 text-gray-700">é©—æ”¶æ•¸é‡</th>
                        <th class="text-right py-3 px-4 text-gray-700">ç¸½é‡‘é¡</th>
                        <th class="text-right py-3 px-4 text-gray-700">RTé‡‘é¡<br><span class="text-xs">(ç¸½é‡‘é¡/é©—æ”¶æ•¸é‡)</span></th>
                        <th class="text-right py-3 px-4 text-gray-700">RTç¸½é‡‘é¡</th>
                        <th class="text-center py-3 px-4 text-gray-700">eRTç¸½è¡¨ ç‹€æ…‹</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr 
                        v-for="(item, idx) in currentResult.comparison_result.items"
                        :key="idx"
                        class="border-b border-gray-100 hover:bg-gray-50"
                      >
                        <td class="py-2 px-4 text-gray-700">{{ item.po_no || '-' }}</td>
                        <td class="py-2 px-4 text-gray-700">{{ item.description || '-' }}</td>
                        <td class="text-center py-2 px-4 text-gray-700">{{ item.accept_qty || item.qty || '-' }}</td>
                        <td class="text-right py-2 px-4 text-gray-700">{{ formatNumber(item.amount) }}</td>
                        <td class="text-right py-2 px-4 text-orange-600 font-medium">
                          {{ formatCurrency(item.rt_amount) }}
                        </td>
                        <td class="text-right py-2 px-4 text-green-600 font-medium">
                          {{ formatCurrency(item.rt_total_amount) }}
                        </td>
                        <td class="text-center py-2 px-4">
                          <span 
                            :class="[
                              'px-2 py-1 rounded text-xs',
                              item.matched_in_buyer 
                                ? 'bg-green-100 text-green-600'
                                : 'bg-yellow-100 text-yellow-600'
                            ]"
                          >
                            {{ item.matched_in_buyer ? 'âœ“ å·²å­˜åœ¨' : '+ æ–°é …ç›®' }}
                          </span>
                        </td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr class="bg-blue-50">
                        <td colspan="4" class="py-3 px-4 text-right text-gray-800 font-semibold">ç¸½è¨ˆï¼š</td>
                        <td class="py-3 px-4 text-right text-orange-600 font-bold">-</td>
                        <td class="py-3 px-4 text-right text-green-600 font-bold">
                          {{ formatCurrency(currentResult.comparison_result.summary.total_amount) }}
                        </td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <!-- æ›´æ–°æŒ‰éˆ• -->
              <div class="flex justify-end">
                <button
                  @click="updateBuyerCSV"
                  :disabled="isUpdating"
                  class="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-lg font-semibold transition flex items-center disabled:opacity-50"
                >
                  <i class="fas fa-save mr-2" :class="{'animate-spin': isUpdating}"></i>
                  {{ isUpdating ? 'æ›´æ–°ä¸­...' : 'æ›´æ–° ç‰©æ–™æ”¶è²¨å–®&æ›´æ–°RTé‡‘é¡' }}
                </button>
              </div>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div v-if="currentResult.comparison_result && currentResult.comparison_result.error" 
                 class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
              <p class="text-red-400">
                <i class="fas fa-exclamation-circle mr-2"></i>
                {{ currentResult.comparison_result.error }}
              </p>
            </div>
          </div>

          <!-- æ¸…ç†ä¸­ç‹€æ…‹ -->
          <div v-if="isCleaningUp" class="mt-8 text-center">
            <i class="fas fa-broom fa-spin text-4xl text-green-500"></i>
            <p class="text-gray-700 mt-4">æ­£åœ¨æ¸…ç†æš«å­˜æª”æ¡ˆä¸¦é‡ç½®ç³»çµ±...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div
      v-if="toast.show"
      :class="[
        'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform z-50',
        toast.type === 'success' ? 'bg-green-500' : 
        toast.type === 'error' ? 'bg-red-500' : 'bg-blue-500',
        toast.show ? 'translate-x-0' : 'translate-x-full'
      ]"
    >
      <div class="flex items-center text-white">
        <i :class="['fas mr-2', 
          toast.type === 'success' ? 'fa-check-circle' : 
          toast.type === 'error' ? 'fa-exclamation-circle' : 
          'fa-info-circle']"></i>
        {{ toast.message }}
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    const API_BASE_URL = 'http://localhost:5000/api';

    // ç­‰å¾…æ‰€æœ‰è…³æœ¬è¼‰å…¥å®Œæˆ
    function waitForSwal() {
      return new Promise((resolve) => {
        const checkSwal = () => {
          if (typeof Swal !== 'undefined') {
            console.log('âœ… SweetAlert2 å·²è¼‰å…¥');
            resolve(true);
          } else {
            console.log('â³ ç­‰å¾… SweetAlert2 è¼‰å…¥...');
            setTimeout(checkSwal, 100);
          }
        };
        checkSwal();
      });
    }

    // å®‰å…¨çš„ SweetAlert2 åŒ…è£å‡½æ•¸
    async function showAlert(options) {
      await waitForSwal();
      
      if (typeof Swal !== 'undefined') {
        console.log('ğŸ¯ é¡¯ç¤º SweetAlert2 å½ˆçª—');
        return await Swal.fire(options);
      } else {
        console.error('âŒ SweetAlert2 è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ');
        // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç€è¦½å™¨åŸç”Ÿ alert
        const message = options.text || options.html?.replace(/<[^>]*>/g, '') || options.title || 'æ“ä½œå®Œæˆ';
        alert(message);
        return { isConfirmed: true };
      }
    }

    // ç­‰å¾… DOM å’Œæ‰€æœ‰è…³æœ¬è¼‰å…¥å®Œæˆ
    document.addEventListener('DOMContentLoaded', async () => {
      await waitForSwal();
      
      createApp({
      data() {
        return {
          username: '',
          isDragging: false,
          isProcessing: false,
          isUpdating: false,
          isCleaningUp: false,
          currentResult: null,
          toast: { show: false, message: '', type: 'success' }
        }
      },
      async mounted(){
          const username = localStorage.getItem('username');
          this.username = username
          console.log("ğŸ‘¤ ä½¿ç”¨è€…åç¨±ï¼š", this.username);
      },
      computed: {
        hasValidData() {
          return this.currentResult && 
                 this.currentResult.gridview_data && 
                 this.currentResult.gridview_data.rows && 
                 this.currentResult.gridview_data.rows.length > 0;
        },
        
        hasPartialMatch() {
          if (!this.currentResult || !this.currentResult.comparison_result) {
            return false;
          }
          
          const summary = this.currentResult.comparison_result.summary;
          return summary.total_items > 0 && 
                 summary.matched_count > 0 && 
                 summary.unmatched_count > 0;
        }
      },
      methods: {
        handleDrop(e) {
          e.preventDefault();
          this.isDragging = false;
          this.handleFiles(e.dataTransfer.files);
        },
        
        handleFileSelect(e) {
          this.handleFiles(e.target.files);
        },
        
        handleFiles(fileList) {
          const file = fileList[0];
          if (!file) return;
          
          const name = file.name || '';
          if (!/\.mht(ml)?$/i.test(name)) {
            this.showToast(`${name} ä¸æ˜¯æœ‰æ•ˆçš„ MHTML æª”æ¡ˆ`, 'error');
            return;
          }
          if (file.size > 50 * 1024 * 1024) {
            this.showToast('æª”æ¡ˆå¤§å°è¶…é 50MB é™åˆ¶', 'error');
            return;
          }
          this.uploadFile(file);
        },
        
        async uploadFile(file) {
          this.isProcessing = true;
          const formData = new FormData();
          formData.append('file', file);
          formData.append('newName', file.name);

          try {
            const res = await axios.post(`${API_BASE_URL}/upload-mhtml`, formData);
            if (res.data && res.data.success) {
              this.currentResult = res.data.data;
              
              // æª¢æŸ¥æ˜¯å¦æœ‰ GridView æ•¸æ“šå’Œè¡¨æ ¼å…§å®¹
              const hasValidGridView = this.currentResult.gridview_data && 
                                     this.currentResult.gridview_data.rows && 
                                     this.currentResult.gridview_data.rows.length > 0;
              
              if (!hasValidGridView) {
                // è§£ææˆåŠŸä½†æ²’æœ‰è¡¨æ ¼æ•¸æ“šï¼Œé¡¯ç¤ºéŒ¯èª¤ä¸¦æ¸…ç†
                await this.showFileInfoErrorAndCleanup('è§£ææˆåŠŸä½†æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¡¨æ ¼è³‡æ–™');
                return;
              }
              
              // æª¢æŸ¥æ¯”å°çµæœ
              if (res.data.data.comparison_result) {
                if (res.data.data.comparison_result.error) {
                  // æœ‰éŒ¯èª¤è¨Šæ¯ï¼Œç›´æ¥æ¸…ç†ä¸¦é¡¯ç¤ºéŒ¯èª¤
                  await this.showNoMatchErrorAndCleanup(null, 'æ‰¾ä¸åˆ° eRTç¸½è¡¨ä¸­æœ‰ç›¸åŒçš„è³‡è¨Š');
                  return;
                } else {
                  // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•åŒ¹é…çš„é …ç›®
                  const hasMatches = res.data.data.comparison_result.summary.matched_count > 0;
                  
                  if (!hasMatches) {
                    // æ²’æœ‰ä»»ä½•åŒ¹é…ï¼Œé¡¯ç¤ºæŸ¥ç„¡è³‡æ–™ä¸¦æ¸…ç†
                    await this.showNoMatchErrorAndCleanup(res.data.data.comparison_result, null);
                    return;
                  } else {
                    this.showToast('æª”æ¡ˆè§£æä¸¦æ¯”å°æˆåŠŸ', 'success');
                  }
                }
              } else {
                this.showToast('æª”æ¡ˆè§£ææˆåŠŸ', 'success');
              }
              
              // è¨­ç½®ä¸€å€‹å»¶é²æª¢æŸ¥ï¼Œå¦‚æœç”¨æˆ¶çœ‹åˆ°äº†æ–‡ä»¶ä¿¡æ¯ä½†æ²’æœ‰è¡¨æ ¼ï¼Œå¯ä»¥æ‰‹å‹•è§¸ç™¼æ¸…ç†
              setTimeout(() => {
                this.checkForIncompleteData();
              }, 2000);
              
            } else {
              throw new Error(res.data?.error || 'ä¸Šå‚³å¤±æ•—');
            }
          } catch (err) {
            console.error(err);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºæª”æ¡ˆè³‡è¨ŠéŒ¯èª¤
            if (err.response?.data?.file_info_error) {
              await this.showFileInfoErrorAndCleanup(err.response.data.message, err.response.data.details);
            } else {
              // å…¶ä»–é¡å‹çš„éŒ¯èª¤
              await showAlert({
                icon: 'error',
                title: 'ä¸Šå‚³å¤±æ•—',
                html: `
                  <div style="text-align: center;">
                      <p style="font-size: 18px; color: #dc3545; font-weight: bold; margin: 20px 0;">
                          æª”æ¡ˆä¸Šå‚³éç¨‹ç™¼ç”ŸéŒ¯èª¤
                      </p>
                      <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca;">
                          <p style="color: #dc3545; font-family: monospace; font-size: 14px;">
                              ${err.message}
                          </p>
                      </div>
                      <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                          <p style="margin: 0; color: #856404; text-align: left;">
                              ğŸ’¡ <strong>å»ºè­°è™•ç†æ–¹å¼ï¼š</strong><br>
                              â€¢ æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸<br>
                              â€¢ ç¢ºèªæª”æ¡ˆå¤§å°æœªè¶…éé™åˆ¶<br>
                              â€¢ é‡æ–°å˜—è©¦ä¸Šå‚³æª”æ¡ˆ<br>
                              â€¢ å¦‚å•é¡ŒæŒçºŒè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡
                          </p>
                      </div>
                  </div>
                `,
                confirmButtonText: 'ç¢ºå®š',
                confirmButtonColor: '#dc3545',
                width: '600px'
              });
            }
          } finally {
            this.isProcessing = false;
          }
        },
        
        checkForIncompleteData() {
          // æª¢æŸ¥æ˜¯å¦å­˜åœ¨åªæœ‰æ–‡ä»¶ä¿¡æ¯ä½†æ²’æœ‰è¡¨æ ¼çš„æƒ…æ³
          if (this.currentResult && 
              (!this.currentResult.gridview_data || 
               !this.currentResult.gridview_data.rows || 
               this.currentResult.gridview_data.rows.length === 0)) {
            
            console.warn('æª¢æ¸¬åˆ°ä¸å®Œæ•´çš„æ•¸æ“šï¼Œæº–å‚™æ¸…ç†');
            // è‡ªå‹•è§¸ç™¼æ¸…ç†ï¼Œå› ç‚ºæ•¸æ“šä¸å®Œæ•´
            this.showFileInfoErrorAndCleanup('æª”æ¡ˆè§£æä¸å®Œæ•´ï¼Œç¼ºå°‘è¡¨æ ¼è³‡æ–™');
          }
        },
        
        async showNoMatchErrorAndCleanup(comparisonResult, customMessage = null) {
          // å–å¾—ç¬¬ä¸€å€‹ PO è™Ÿç¢¼ä½œç‚ºç¯„ä¾‹
          const firstPO = comparisonResult?.items?.[0]?.po_no || 'ç„¡æ³•å–å¾—';
          const totalItems = comparisonResult?.summary?.total_items || 0;
          
          // é¡¯ç¤ºæŸ¥ç„¡è³‡æ–™éŒ¯èª¤æç¤º
          await showAlert({
            icon: 'error',
            title: 'æŸ¥ç„¡è³‡æ–™',
            html: `
              <div style="text-align: center;">
                  <p style="font-size: 18px; color: #dc3545; font-weight: bold; margin: 20px 0;">
                      eRTç¸½è¡¨ è¡¨å–®ç„¡æ­¤é …ç›®
                  </p>
                  <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca; margin: 20px 0;">
                      <p style="color: #666; margin-bottom: 10px;">æª¢æŸ¥çš„ PO ç·¨è™Ÿï¼š</p>
                      <p style="color: #dc3545; font-weight: bold; font-family: monospace; font-size: 16px;">
                          ${firstPO}
                      </p>
                      ${totalItems > 0 ? `
                      <p style="color: #666; margin-top: 10px; font-size: 14px;">
                          å…±æª¢æŸ¥ ${totalItems} ç­†è³‡æ–™ï¼Œå‡ç„¡åŒ¹é…
                      </p>
                      ` : ''}
                      ${customMessage ? `
                      <p style="color: #dc3545; margin-top: 10px; font-size: 14px;">
                          ${customMessage}
                      </p>
                      ` : ''}
                  </div>
                  <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                      <p style="margin: 0; color: #856404; text-align: left;">
                          ğŸ’¡ <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                          â€¢ PO è™Ÿç¢¼è¼¸å…¥éŒ¯èª¤<br>
                          â€¢ æ­¤ PO å°šæœªå»ºç«‹åœ¨ eRTç¸½è¡¨ ä¸­<br>
                          â€¢ PO å·²è¢«åˆªé™¤æˆ–ä¿®æ”¹<br>
                          â€¢ eRTç¸½è¡¨ä¸­æœ‰ç›¸åŒçš„è³‡è¨Š æª”æ¡ˆæœªç¶“éå» å•†æ‰¿è«¾äº¤æœŸä»‹é¢éæ¿¾
                      </p>
                  </div>
                  <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 6px;">
                      <p style="margin: 0; color: #0066cc; font-size: 14px;">
                          ğŸ“‹ ç¢ºå®šå¾Œå°‡è‡ªå‹•æ¸…ç†å¾Œå°è³‡è¨Šä¸¦é‡ç½®ç³»çµ±
                      </p>
                  </div>
              </div>
            `,
            confirmButtonText: 'ç¢ºå®šï¼Œæ¸…ç†ä¸¦é‡ç½®',
            confirmButtonColor: '#dc3545',
            width: '600px',
            allowOutsideClick: false
          });
          
          // è‡ªå‹•æ¸…ç†å¾Œå°è³‡è¨Š
          await this.performCleanupAndReset();
        },
        
        async showFileInfoErrorAndCleanup(message, details = null) {
          // é¡¯ç¤ºæª”æ¡ˆè³‡è¨ŠéŒ¯èª¤æç¤º
          await showAlert({
            icon: 'error',
            title: 'æª”æ¡ˆè³‡è¨ŠéŒ¯èª¤',
            html: `
              <div style="text-align: center;">
                  <p style="font-size: 18px; color: #dc3545; font-weight: bold; margin: 20px 0;">
                      MHTML æª”æ¡ˆè§£æå¤±æ•—
                  </p>
                  <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca; margin: 20px 0;">
                      <p style="color: #666; margin-bottom: 10px;">éŒ¯èª¤è¨Šæ¯ï¼š</p>
                      <p style="color: #dc3545; font-weight: bold; font-size: 14px;">
                          ${message}
                      </p>
                  </div>
                  <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                      <p style="margin: 0; color: #856404; text-align: left;">
                          ğŸ’¡ <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                          â€¢ æª”æ¡ˆæå£æˆ–æ ¼å¼ä¸æ­£ç¢º<br>
                          â€¢ ä¸æ˜¯æœ‰æ•ˆçš„ MHTML æª”æ¡ˆ<br>
                          â€¢ æª”æ¡ˆå…§å®¹ç¼ºå°‘å¿…è¦çš„è¡¨æ ¼è³‡æ–™<br>
                          â€¢ æª”æ¡ˆç·¨ç¢¼å•é¡Œ<br>
                          â€¢ è¡¨æ ¼çµæ§‹èˆ‡é æœŸä¸ç¬¦
                      </p>
                  </div>
                  <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 6px;">
                      <p style="margin: 0; color: #0066cc; font-size: 14px;">
                          ğŸ“‹ ç¢ºå®šå¾Œå°‡è‡ªå‹•æ¸…ç†å¾Œå°è³‡è¨Šä¸¦é‡ç½®ç³»çµ±
                      </p>
                  </div>
              </div>
            `,
            confirmButtonText: 'ç¢ºå®šï¼Œæ¸…ç†ä¸¦é‡ç½®',
            confirmButtonColor: '#dc3545',
            width: '600px',
            allowOutsideClick: false
          });
          
          // è‡ªå‹•æ¸…ç†å¾Œå°è³‡è¨Š
          await this.performCleanupAndReset();
        },
        
        async updateBuyerCSV() {
          if (!this.currentResult || !this.currentResult.comparison_result) return;
          
          this.isUpdating = true;
          
          try {
            // åªé¸æ“‡åŒ¹é…çš„é …ç›®é€²è¡Œæ›´æ–°
            const matchedItems = this.currentResult.comparison_result.items
              .filter(item => item.matched_in_buyer)
              .map(item => ({
                po_no: item.po_no,
                description: item.description,
                rt_amount: item.rt_amount,
                rt_total_amount: item.rt_total_amount
              }));
            
            const totalItems = this.currentResult.comparison_result.items.length;
            const unmatchedCount = totalItems - matchedItems.length;
            
            console.log('æº–å‚™æ›´æ–° eRTç¸½è¡¨');
            console.log('ç¸½é …ç›®æ•¸:', totalItems);
            console.log('åŒ¹é…é …ç›®æ•¸:', matchedItems.length);
            console.log('è·³éæœªåŒ¹é…é …ç›®æ•¸:', unmatchedCount);
            
            if (matchedItems.length === 0) {
              // æ²’æœ‰åŒ¹é…é …ç›®å¯æ›´æ–°
              await showAlert({
                icon: 'warning',
                title: 'ç„¡å¯æ›´æ–°é …ç›®',
                html: `
                  <div style="text-align: center;">
                      <p style="font-size: 18px; color: #856404; font-weight: bold; margin: 20px 0;">
                          æ‰€æœ‰é …ç›®å‡ç„¡æ³•åŒ¹é… eRTç¸½è¡¨
                      </p>
                      <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; margin: 20px 0;">
                          <p style="color: #856404; font-size: 14px;">
                              å…± ${totalItems} ç­†è³‡æ–™ï¼Œå‡ç„¡æ³•åœ¨ eRTç¸½è¡¨ ä¸­æ‰¾åˆ°å°æ‡‰çš„ PO è™Ÿç¢¼ï¼Œå› æ­¤ç„¡æ³•é€²è¡Œæ›´æ–°ã€‚
                          </p>
                      </div>
                      <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
                          <p style="margin: 0; color: #0066cc; font-size: 14px;">
                              ğŸ’¡ å»ºè­°æª¢æŸ¥ PO è™Ÿç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–ç¢ºèª eRTç¸½è¡¨ æ˜¯å¦ç‚ºæœ€æ–°ç‰ˆæœ¬ã€‚
                          </p>
                      </div>
                  </div>
                `,
                confirmButtonText: 'ç¢ºå®š',
                confirmButtonColor: '#856404',
                width: '500px'
              });
              return;
            }
            
            const res = await axios.post(`${API_BASE_URL}/update-buyer-csv`, {
              items: matchedItems
            });
            
            console.log('æ›´æ–° CSV API éŸ¿æ‡‰:', res.data);
            
            if (res.data && res.data.success) {
              // æ§‹å»ºæˆåŠŸè¨Šæ¯
              let successMessage = `âœ… ${res.data.message}`;
              
              if (unmatchedCount > 0) {
                successMessage += `<br><br>ğŸ“Š <strong>è™•ç†çµ±è¨ˆï¼š</strong><br>`;
                successMessage += `â€¢ æˆåŠŸæ›´æ–°ï¼š${matchedItems.length} ç­†<br>`;
                successMessage += `â€¢ è·³éæœªåŒ¹é…ï¼š${unmatchedCount} ç­†`;
              }
              
              // ä½¿ç”¨ SweetAlert2 é¡¯ç¤ºæˆåŠŸè¨Šæ¯
              await showAlert({
                icon: 'success',
                title: 'æ›´æ–°å®Œæˆï¼',
                html: `
                  <div class="text-left">
                    <p class="mb-2">${successMessage}</p>
                    <p class="text-sm text-gray-600 mt-3">ç³»çµ±å°‡è‡ªå‹•æ¸…ç†æš«å­˜æª”æ¡ˆä¸¦é‡ç½®é é¢</p>
                  </div>
                `,
                confirmButtonText: 'ç¢ºå®š',
                confirmButtonColor: '#10b981',
                timer: unmatchedCount > 0 ? 5000 : 3000,  // å¦‚æœæœ‰è·³éé …ç›®ï¼Œå»¶é•·é¡¯ç¤ºæ™‚é–“
                timerProgressBar: true
              });
              
              // æª¢æŸ¥å¾Œç«¯æ˜¯å¦æŒ‡ç¤ºéœ€è¦æ¸…ç†ï¼ˆå¤šå€‹æ¢ä»¶æª¢æŸ¥ï¼‰
              const needsCleanup = res.data.should_cleanup || res.data.cleanup_required || res.data.updated_count > 0;
              console.log('æ˜¯å¦éœ€è¦æ¸…ç†:', needsCleanup);
              
              if (needsCleanup) {
                console.log('é–‹å§‹åŸ·è¡Œè‡ªå‹•æ¸…ç†å’Œé‡ç½®...');
                await this.performCleanupAndReset();
              } else {
                console.log('å¾Œç«¯æœªæŒ‡ç¤ºéœ€è¦æ¸…ç†ï¼Œæ‰‹å‹•è§¸ç™¼é‡ç½®');
                // å³ä½¿å¾Œç«¯æ²’æœ‰æ˜ç¢ºæŒ‡ç¤ºï¼ŒæˆåŠŸæ›´æ–°å¾Œä¹Ÿæ‡‰è©²æ¸…ç†
                await this.performCleanupAndReset();
              }
            } else {
              // æ›´æ–°å¤±æ•— - æª¢æŸ¥æ˜¯å¦ç‚ºåŒ¹é…å¤±æ•—
              const errorMessage = res.data?.error || 'æ›´æ–°å¤±æ•—';
              
              if (res.data?.updated_count === 0 || errorMessage.includes('æ²’æœ‰æ‰¾åˆ°åŒ¹é…') || errorMessage.includes('æ‰¾ä¸åˆ°')) {
                // åŒ¹é…å¤±æ•—çš„æƒ…æ³
                await showAlert({
                  icon: 'error',
                  title: 'æŸ¥ç„¡è³‡æ–™',
                  html: `
                    <div style="text-align: center;">
                        <p style="font-size: 18px; color: #dc3545; font-weight: bold; margin: 20px 0;">
                            eRTç¸½è¡¨ è¡¨å–®ç„¡æ­¤é …ç›®
                        </p>
                        <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca; margin: 20px 0;">
                            <p style="color: #666; margin-bottom: 10px;">PO ç·¨è™Ÿï¼š</p>
                            <p style="color: #dc3545; font-weight: bold; font-family: monospace; font-size: 16px;">
                                ${this.currentResult?.comparison_result?.items?.[0]?.po_no || 'ç„¡æ³•å–å¾—'}
                            </p>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <p style="margin: 0; color: #856404; text-align: left;">
                                ğŸ’¡ <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                                â€¢ PO è™Ÿç¢¼è¼¸å…¥éŒ¯èª¤<br>
                                â€¢ æ­¤ PO å°šæœªå»ºç«‹åœ¨ eRTç¸½è¡¨ ä¸­<br>
                                â€¢ PO å·²è¢«åˆªé™¤æˆ–ä¿®æ”¹<br>
                                â€¢ eRTç¸½è¡¨ä¸­æœ‰ç›¸åŒçš„è³‡è¨Š æª”æ¡ˆæœªç¶“éå» å•†æ‰¿è«¾äº¤æœŸéæ¿¾
                            </p>
                        </div>
                    </div>
                  `,
                  confirmButtonText: 'ç¢ºå®š',
                  confirmButtonColor: '#dc3545',
                  width: '600px'
                });
              } else {
                // å…¶ä»–éŒ¯èª¤
                await showAlert({
                  icon: 'error',
                  title: 'æ›´æ–°å¤±æ•—',
                  html: `
                    <div style="text-align: center;">
                        <p style="font-size: 18px; color: #dc3545; font-weight: bold; margin: 20px 0;">
                            ç³»çµ±è™•ç†ç™¼ç”ŸéŒ¯èª¤
                        </p>
                        <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca;">
                            <p style="color: #dc3545; font-family: monospace; font-size: 14px;">
                                ${errorMessage}
                            </p>
                        </div>
                    </div>
                  `,
                  confirmButtonText: 'ç¢ºå®š',
                  confirmButtonColor: '#dc3545',
                  width: '500px'
                });
              }
            }
          } catch (err) {
            console.error('æ›´æ–° CSV éŒ¯èª¤:', err);
            
            // ç¶²è·¯éŒ¯èª¤æˆ–å…¶ä»–ç•°å¸¸
            await showAlert({
              icon: 'error',
              title: 'ç³»çµ±éŒ¯èª¤',
              html: `
                <div style="text-align: center;">
                    <p style="font-size: 18px; color: #dc3545; font-weight: bold; margin: 20px 0;">
                        æ›´æ–°éç¨‹ä¸­ç™¼ç”Ÿç³»çµ±éŒ¯èª¤
                    </p>
                    <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca;">
                        <p style="color: #dc3545; font-family: monospace; font-size: 14px;">
                            ${err.message}
                        </p>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <p style="margin: 0; color: #856404; text-align: left;">
                            ğŸ’¡ <strong>å»ºè­°è™•ç†æ–¹å¼ï¼š</strong><br>
                            â€¢ æª¢æŸ¥ç¶²è·¯é€£ç·šç‹€æ…‹<br>
                            â€¢ é‡æ–°æ•´ç†é é¢å¾Œå†è©¦<br>
                            â€¢ ç¢ºèªå¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ<br>
                            â€¢ å¦‚å•é¡ŒæŒçºŒç™¼ç”Ÿè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡
                        </p>
                    </div>
                </div>
              `,
              confirmButtonText: 'ç¢ºå®š',
              confirmButtonColor: '#dc3545',
              width: '600px'
            });
          } finally {
            this.isUpdating = false;
          }
        },
        
        async performCleanupAndReset() {
          try {
            this.isCleaningUp = true;
            console.log('=== é–‹å§‹æ¸…ç†æµç¨‹ ===');
            
            // é¡¯ç¤ºæ¸…ç†ç‹€æ…‹
            this.showToast('æ­£åœ¨æ¸…ç†å¾Œå°è³‡è¨Š...', 'info');
            
            // å»¶é²1.5ç§’è®“ç”¨æˆ¶çœ‹åˆ°æ¸…ç†ç‹€æ…‹
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // èª¿ç”¨æ¸…ç† API
            console.log('èª¿ç”¨æ¸…ç† API...');
            const cleanupRes = await axios.post(`${API_BASE_URL}/cleanup-processed`);
            console.log('æ¸…ç† API éŸ¿æ‡‰:', cleanupRes.data);
            
            if (cleanupRes.data && cleanupRes.data.success) {
              console.log('âœ… æ¸…ç†æˆåŠŸ:', cleanupRes.data.message);
              console.log('ğŸ“Š æ¸…ç†çµ±è¨ˆ:', {
                removed: cleanupRes.data.files_removed,
                remaining_processed: cleanupRes.data.remaining_processed_files,
                remaining_upload: cleanupRes.data.remaining_upload_files
              });
              
              // é‡ç½®å‰ç«¯ç‹€æ…‹åˆ°åˆå§‹ç‹€æ…‹
              this.resetToInitialState();
              
              // é¡¯ç¤ºè©³ç´°çš„å®Œæˆè¨Šæ¯
              this.showToast(`âœ… æ›´æ–°å®Œæˆï¼å·²æ¸…ç† ${cleanupRes.data.files_removed} å€‹æš«å­˜æª”æ¡ˆ`, 'success');
              
              // é¡å¤–å»¶é²ç¢ºä¿ç‹€æ…‹å®Œå…¨é‡ç½®
              setTimeout(() => {
                console.log('=== æ¸…ç†æµç¨‹å®Œæˆï¼Œç³»çµ±å·²é‡ç½® ===');
              }, 500);
              
            } else {
              console.warn('âš ï¸ æ¸…ç†éŸ¿æ‡‰ç•°å¸¸:', cleanupRes.data?.error || 'æ¸…ç†æ™‚é‡åˆ°å•é¡Œ');
              // å³ä½¿æ¸…ç†å¤±æ•—ï¼Œä»ç„¶é‡ç½®å‰ç«¯ç‹€æ…‹
              this.resetToInitialState();
              this.showToast('âœ… æ›´æ–°å®Œæˆï¼ä½†æ¸…ç†æ™‚é‡åˆ°å•é¡Œ', 'info');
            }
          } catch (error) {
            console.error('âŒ æ¸…ç†éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
            // å³ä½¿æ¸…ç† API å¤±æ•—ï¼Œä»ç„¶é‡ç½®å‰ç«¯ç‹€æ…‹
            this.resetToInitialState();
            this.showToast('âœ… æ›´æ–°å®Œæˆï¼ä½†å¾Œå°æ¸…ç†å¤±æ•—', 'error');
          } finally {
            this.isCleaningUp = false;
            console.log('=== æ¸…ç†æµç¨‹çµæŸ ===');
          }
        },
        
        resetToInitialState() {
          console.log('ğŸ”„ é‡ç½®ç³»çµ±ç‹€æ…‹åˆ°åˆå§‹å€¼...');
          
          // é‡ç½®æ‰€æœ‰ç‹€æ…‹åˆ°åˆå§‹å€¼
          this.currentResult = null;
          this.isDragging = false;
          this.isProcessing = false;
          this.isUpdating = false;
          this.isCleaningUp = false;
          
          // æ¸…ç©ºæ–‡ä»¶è¼¸å…¥
          if (this.$refs.fileInput) {
            this.$refs.fileInput.value = '';
          }
          
          // å¼·åˆ¶ Vue é‡æ–°æ¸²æŸ“
          this.$nextTick(() => {
            console.log('âœ… ç³»çµ±å·²é‡ç½®åˆ°åˆå§‹ç‹€æ…‹');
            console.log('ğŸ“Š ç•¶å‰ç‹€æ…‹:', {
              currentResult: this.currentResult,
              isDragging: this.isDragging,
              isProcessing: this.isProcessing,
              isUpdating: this.isUpdating,
              isCleaningUp: this.isCleaningUp
            });
          });
        },
        
        resetUpload() {
          this.resetToInitialState();
          this.showToast('å·²é‡ç½®åˆ°åˆå§‹ç‹€æ…‹', 'info');
        },
        
        // æ·»åŠ æ‰‹å‹•æ¸…ç†æŒ‰éˆ•çš„åŠŸèƒ½ï¼ˆåœ¨æ–‡ä»¶ä¿¡æ¯å€åŸŸï¼‰
        async forceCleanupAndReset() {
          const result = await showAlert({
            icon: 'warning',
            title: 'ç¢ºèªæ¸…ç†æ“ä½œ',
            html: `
              <div style="text-align: center;">
                  <p style="font-size: 18px; color: #856404; font-weight: bold; margin: 20px 0;">
                      å³å°‡æ¸…ç†æ‰€æœ‰æš«å­˜è³‡æ–™
                  </p>
                  <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; margin: 20px 0;">
                      <p style="color: #856404; font-size: 14px; margin: 0;">
                          æ­¤æ“ä½œå°‡æœƒï¼š<br>
                          â€¢ æ¸…ç†å·²ä¸Šå‚³çš„æª”æ¡ˆ<br>
                          â€¢ é‡ç½®ç³»çµ±åˆ°åˆå§‹ç‹€æ…‹<br>
                          â€¢ æ¸…é™¤æ‰€æœ‰è§£æçµæœ
                      </p>
                  </div>
                  <div style="margin-top: 15px; padding: 10px; background: #fee2e2; border-radius: 6px;">
                      <p style="margin: 0; color: #dc2626; font-size: 14px; font-weight: bold;">
                          âš ï¸ æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ
                      </p>
                  </div>
              </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'ç¢ºå®šæ¸…ç†',
            cancelButtonText: 'å–æ¶ˆ',
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6b7280',
            width: '500px'
          });
          
          if (result.isConfirmed) {
            await this.performCleanupAndReset();
          }
        },
        
        formatCurrency(amount) {
          if (!amount && amount !== 0) return '-';
          return new Intl.NumberFormat('zh-TW', {
            style: 'currency',
            currency: 'TWD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
          }).format(amount);
        },
        
        formatNumber(value) {
          if (!value) return '-';
          const num = parseFloat(String(value).replace(/[^0-9.-]/g, ''));
          if (isNaN(num)) return value;
          return num.toLocaleString('zh-TW');
        },

        goeRTDashboard(){
          localStorage.setItem('username', this.username);
          window.location.href = 'eRT_page.html'; 
        },
        
        // Rule èªªæ˜åŠŸèƒ½
        async showRuleExplanation() {
          console.log('ğŸ§ª é¡¯ç¤º Rule èªªæ˜...');
          await showAlert({
            icon: 'info',
            title: 'Rule èªªæ˜ - ç‰©æ–™æ”¶è²¨å–®è™•ç†æµç¨‹',
            html: `
              <div style="text-align: left; max-height: 80vh; overflow-y: auto;">
                  <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff; margin-bottom: 25px;">
                      <h4 style="color: #007bff; margin: 0 0 15px 0; font-size: 18px;">ğŸ“‹ ç³»çµ±åŠŸèƒ½èªªæ˜</h4>
                      <p style="margin: 0; color: #495057; line-height: 1.8; font-size: 15px;">
                          æœ¬ç³»çµ±ç”¨æ–¼è™•ç†ç‰©æ–™æ”¶è²¨å–®çš„ MHTML æª”æ¡ˆï¼Œè‡ªå‹•è§£æè¡¨æ ¼è³‡æ–™ä¸¦èˆ‡ eRTç¸½è¡¨ä¸­æœ‰ç›¸åŒçš„è³‡è¨Š é€²è¡Œæ¯”å°ï¼Œ
                          è¨ˆç®— RT é‡‘é¡ä¸¦æ›´æ–°åˆ°ç³»çµ±ä¸­ã€‚
                      </p>
                  </div>
                  
                  <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 25px;">
                      <h4 style="color: #28a745; margin: 0 0 20px 0; font-size: 18px;">ğŸ“ æ­¥é©Ÿä¸€ï¼šæª”æ¡ˆæº–å‚™</h4>
                      <div style="display: flex; flex-direction: column; gap: 15px;">
                          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #d4edda; text-align: center;">
                              <img src="../static/picture/html_page.png" 
                                   alt="ç‰©æ–™æ”¶è²¨å–®ç¯„ä¾‹" 
                                   style="max-width: 700px; height: auto; border-radius: 6px; border: 2px solid #28a745; cursor: pointer; display: block; margin: 0 auto;"
                                   onclick="window.open('../static/picture/html_page.png', '_blank')">
                              <p style="margin: 10px 0 0 0; font-size: 14px; color: #6c757d; text-align: center; font-weight: 500;">
                                  ğŸ“„ ç‰©æ–™æ”¶è²¨å–®é é¢ç¯„ä¾‹ï¼ˆé»æ“Šåœ–ç‰‡å¯æ”¾å¤§æŸ¥çœ‹ï¼‰<br>
                                  <span style="color: #28a745;">â€» éœ€å¦å­˜ç‚º MHTML æ ¼å¼</span>
                              </p>
                          </div>
                      </div>
                  </div>
                  
                  <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 25px;">
                      <h4 style="color: #856404; margin: 0 0 20px 0; font-size: 18px;">ğŸ’¾ æ­¥é©ŸäºŒï¼šæª”æ¡ˆå„²å­˜</h4>
                      <div style="display: flex; flex-direction: column; gap: 15px;">
                          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; text-align: center; display: flex; flex-direction: column; align-items: center;">
                              <img src="../static/picture/store_example.png" 
                                   alt="å¦å­˜ç‚º MHTML" 
                                   style="max-width: 700px; width: auto; height: auto; border-radius: 6px; border: 2px solid #ffc107; cursor: pointer; display: block;"
                                   onclick="window.open('../static/picture/store_example.png', '_blank')">
                              <p style="margin: 10px 0 0 0; font-size: 14px; color: #6c757d; text-align: center; font-weight: 500;">
                                  ğŸ’» å¦å­˜ç‚º "ç¶²é ï¼Œå–®ä¸€æª”æ¡ˆ (*.mhtml)" æ ¼å¼ï¼ˆé»æ“Šåœ–ç‰‡å¯æ”¾å¤§æŸ¥çœ‹ï¼‰<br>
                                  <span style="color: #856404;">â€» è«‹é¸æ“‡ "æª”æ¡ˆé¡å‹" ç‚º MHTML æ ¼å¼</span>
                              </p>
                          </div>
                      </div>
                  </div>
                  
                  <div style="background: #e7f3ff; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8; margin-bottom: 25px;">
                      <h4 style="color: #0c5460; margin: 0 0 15px 0; font-size: 18px;">âš™ï¸ è™•ç†æµç¨‹</h4>
                      <ol style="margin: 0; padding-left: 25px; color: #495057; line-height: 2; font-size: 15px;">
                          <li><strong>ä¸Šå‚³æª”æ¡ˆï¼š</strong>æ‹–æ›³æˆ–é»æ“Šä¸Šå‚³ MHTML æª”æ¡ˆ</li>
                          <li><strong>è‡ªå‹•è§£æï¼š</strong>ç³»çµ±è§£æå¾Œè¡¨æ ¼è³‡æ–™</li>
                          <li><strong>æ•¸æ“šæ¯”å°ï¼š</strong>æ ¹æ“š PO No. èˆ‡ eRTç¸½è¡¨ æ¯”å°</li>
                          <li><strong>è¨ˆç®— RTï¼š</strong>RTé‡‘é¡ = ç¸½é‡‘é¡ Ã· é©—æ”¶æ•¸é‡</li>
                          <li><strong>æ›´æ–°è³‡æ–™ï¼š</strong>å°‡çµæœæ›´æ–°åˆ° eRTç¸½è¡¨ä¸­</li>
                      </ol>
                  </div>
                  
                  <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
                      <h4 style="color: #721c24; margin: 0 0 15px 0; font-size: 18px;">âš ï¸ æ³¨æ„äº‹é …</h4>
                      <ul style="margin: 0; padding-left: 25px; color: #495057; line-height: 2; font-size: 15px;">
                          <li>æª”æ¡ˆå¤§å°é™åˆ¶ï¼š50MB</li>
                          <li>æ”¯æ´æ ¼å¼ï¼š.mhtml</li>
                          <li>PO è™Ÿç¢¼å¿…é ˆåœ¨ERTç¸½è¡¨ä¸­ä¸”æœªå‡ºç¾<br></li>
                          <li>è™•ç†å®Œæˆå¾Œæœƒè‡ªå‹•æ¸…ç†æš«å­˜æª”æ¡ˆ</li>
                      </ul>
                  </div>
              </div>
            `,
            confirmButtonText: 'æˆ‘çŸ¥é“äº†',
            confirmButtonColor: '#007bff',
            width: '950px',
            customClass: {
              popup: 'rule-explanation-popup'
            }
          });
        },
        
        showToast(message, type = 'success') {
          this.toast = { show: true, message, type };
          setTimeout(() => (this.toast.show = false), 3000);
        }
      }
    }).mount('#app');
    
    }); // DOMContentLoaded çµæŸ
  </script>
</body>
</html>