<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>åˆä½µç¢ºèª - åˆ†æ‰¹è®Šå›å–®ç­†</title>
    <link href="../static/css/tailwind.min.css" rel="stylesheet" />
    <script src="../static/js/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .compare-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 14px;
        }
        .compare-table th,
        .compare-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .compare-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .old-data {
            background-color: #fff3cd;
        }
        .new-data {
            background-color: #d4edda;
        }
        .editable-cell {
            position: relative;
        }
        .editable-cell input {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #3b82f6;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>

<body class="min-h-screen p-6 bg-gradient-to-br from-[#fffdf9] via-[#faf6f0] to-[#f3eee8]">
    <div id="app" class="max-w-[1400px] mx-auto">
        
        <!-- é ‚éƒ¨æ¨™é¡Œ + é€²åº¦ + æ“ä½œæŒ‰éˆ• -->
        <div class="bg-gradient-to-r from-blue-50 via-sky-50 to-indigo-50 
                    rounded-2xl shadow-md border border-slate-200 
                    px-6 py-5 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-800 leading-snug">
                        <span class="inline-block align-middle mr-2">ğŸ“„</span>
                        <span class="align-middle">åˆä½µç¢ºèª - åˆ†æ‰¹è®Šå›å–®ç­†</span>
                    </h1>
                    <p class="text-slate-600 text-sm mt-2">
                        ä»¥ä¸‹é …ç›®å¾åˆ†æ‰¹ç‹€æ…‹è®Šå›å–®ç­†,è«‹ç¢ºèªå¾Œåˆä½µ
                    </p>
                </div>
                <!-- âœ… é€²åº¦é¡¯ç¤ºç§»åˆ°å³ä¸Šè§’ -->
                <div class="text-right">
                    <div class="inline-block bg-white px-6 py-3 rounded-xl shadow-sm border-2" 
                         :class="allProcessed ? 'border-green-500' : 'border-blue-500'">
                        <p class="text-sm text-slate-600 mb-1">è™•ç†é€²åº¦</p>
                        <p class="text-2xl font-bold" 
                           :class="allProcessed ? 'text-green-600' : 'text-blue-600'">
                            {{ processedCount }} / {{ mergeItems.length }}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ”´ğŸ”´ğŸ”´ æ–°å¢:é ‚éƒ¨æ“ä½œæŒ‰éˆ• -->
            <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                <button
                    @click="cancelAll"
                    class="px-6 py-2.5 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition font-medium"
                >
                    âŒ å–æ¶ˆå…¨éƒ¨
                </button>
                <button
                    v-if="!allProcessed"
                    @click="confirmAllRemaining"
                    :disabled="processingAll"
                    class="px-6 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition disabled:opacity-50 font-medium"
                >
                    <span v-if="!processingAll">ğŸš€ å…¨éƒ¨åˆä½µ</span>
                    <span v-else>â³ è™•ç†ä¸­...</span>
                </button>
                <!-- âœ… åªæœ‰å…¨éƒ¨å®Œæˆæ‰é¡¯ç¤ºè¿”å›æŒ‰éˆ• -->
                <button
                    v-if="allProcessed"
                    @click="returnToMain"
                    class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg transition font-medium"
                >
                    âœ… è¿”å›ä¸»é é¢
                </button>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­ -->
        <div v-if="loading" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-slate-600">è¼‰å…¥ä¸­...</p>
        </div>

        <!-- ä¸»è¦å…§å®¹ -->
        <div v-else-if="mergeItems.length > 0">
            
            <!-- æ¯å€‹éœ€è¦åˆä½µçš„é …ç›® -->
            <div 
                v-for="(item, idx) in mergeItems" 
                :key="idx"
                class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 mb-6"
                :class="{ 'opacity-50': item.processed }"
            >
                <!-- é …ç›®æ¨™é¡Œ -->
                <div class="border-b border-slate-200 pb-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-blue-700">
                                ğŸ“¦ PO {{ item.po_no }} - Item {{ item.item }}
                            </h2>
                            <p class="text-sm text-slate-600 mt-1">
                                ç›®å‰æœ‰ <span class="font-bold text-red-600">{{ item.csv_count }} ç­†åˆ†æ‰¹è³‡æ–™</span>,
                                æ–°è³‡æ–™åªæœ‰ <span class="font-bold text-green-600">{{ item.xls_count }} ç­†</span>
                            </p>
                        </div>
                        <!-- âœ… è™•ç†ç‹€æ…‹æ¨™è¨˜ -->
                        <div v-if="item.processed" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-bold">
                            âœ… å·²å®Œæˆ
                        </div>
                    </div>
                </div>

                <!-- å°æ¯”è¡¨æ ¼ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- å·¦å´:ç›®å‰çš„åˆ†æ‰¹è³‡æ–™ -->
                    <div>
                        <h3 class="text-lg font-bold text-red-600 mb-3 flex items-center gap-2">
                            <span>âŒ</span>
                            <span>ç›®å‰ç‹€æ…‹ ({{ item.csv_count }} ç­†åˆ†æ‰¹)</span>
                        </h3>
                        <div class="overflow-auto max-h-[400px] border border-slate-200 rounded-lg">
                            <table class="compare-table">
                                <thead class="sticky top-0">
                                    <tr class="old-data">
                                        <th>ç­†æ¬¡</th>
                                        <th>å“å</th>
                                        <th>äº¤æœŸ</th>
                                        <th>æ•¸é‡</th>
                                        <th>å‚™è¨»</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(row, i) in item.csv_data" :key="i">
                                        <td class="text-center">{{ i + 1 }}</td>
                                        <td>{{ row.description }}</td>
                                        <td class="text-center">{{ row.delivery }}</td>
                                        <td class="text-center font-bold">{{ row.sod_qty }}</td>
                                        <td class="text-center">
                                            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">
                                                {{ row.note }}
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- å³å´:æ–°çš„åˆä½µè³‡æ–™ (âœ… å¯ç·¨è¼¯) -->
                    <div>
                        <h3 class="text-lg font-bold text-green-600 mb-3 flex items-center gap-2">
                            <span>âœ…</span>
                            <span>åˆä½µå¾Œ ({{ item.xls_count }} ç­†)</span>
                            <span v-if="item.editing" class="text-sm text-blue-600 ml-2">
                                âœï¸ ç·¨è¼¯æ¨¡å¼
                            </span>
                        </h3>
                        <div class="overflow-auto max-h-[400px] border border-slate-200 rounded-lg">
                            <table class="compare-table">
                                <thead class="sticky top-0">
                                    <tr class="new-data">
                                        <th>ç­†æ¬¡</th>
                                        <th>å“å</th>
                                        <th>äº¤æœŸ</th>
                                        <th>æ•¸é‡</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(row, i) in item.xls_data" :key="i">
                                        <td class="text-center">{{ i + 1 }}</td>
                                        <!-- âœ… å“åå¯ç·¨è¼¯ -->
                                        <td class="editable-cell">
                                            <span v-if="!item.editing">{{ row.description }}</span>
                                            <input v-else v-model="row.description" type="text" />
                                        </td>
                                        <!-- âœ… äº¤æœŸå¯ç·¨è¼¯ -->
                                        <td class="text-center editable-cell">
                                            <span v-if="!item.editing">{{ row.delivery }}</span>
                                            <input v-else v-model="row.delivery" type="text" class="text-center" />
                                        </td>
                                        <!-- âœ… æ•¸é‡å¯ç·¨è¼¯ -->
                                        <td class="text-center editable-cell">
                                            <span v-if="!item.editing" class="font-bold text-green-600">{{ row.sod_qty }}</span>
                                            <input v-else v-model="row.sod_qty" type="text" class="text-center font-bold" />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="mt-6 flex justify-end gap-3">
                    <!-- âœ… ç·¨è¼¯æŒ‰éˆ• -->
                    <button
                        v-if="!item.processed"
                        @click="toggleEdit(item)"
                        class="px-5 py-2 rounded-lg transition"
                        :class="item.editing 
                            ? 'bg-blue-600 hover:bg-blue-700 text-white' 
                            : 'bg-yellow-400 hover:bg-yellow-500 text-slate-800'"
                    >
                        <span v-if="!item.editing">âœï¸ ç·¨è¼¯</span>
                        <span v-else>ğŸ’¾ å„²å­˜ç·¨è¼¯</span>
                    </button>
                    
                    <!-- ç¢ºèªåˆä½µæŒ‰éˆ• -->
                    <button
                        v-if="!item.processed"
                        @click="confirmMergeItem(item, idx)"
                        :disabled="item.processing || item.editing"
                        class="px-5 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span v-if="!item.processing">âœ… ç¢ºèªåˆä½µ</span>
                        <span v-else>â³ è™•ç†ä¸­...</span>
                    </button>
                </div>
            </div>

            <!-- ğŸ”´ ç§»é™¤åº•éƒ¨æ“ä½œå€åŸŸ,å·²ç¶“ç§»åˆ°é ‚éƒ¨ -->
        </div>

        <!-- ç„¡è³‡æ–™ -->
        <div v-else class="text-center py-20">
            <p class="text-slate-600 text-lg">æ‰¾ä¸åˆ°éœ€è¦åˆä½µçš„é …ç›®</p>
            <button
                @click="returnToMain"
                class="mt-4 px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition"
            >
                è¿”å›ä¸»é é¢
            </button>
        </div>

    </div>

    <script src="../static/js/func/mergeConfirmation.js"></script>
</body>
</html>