<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>e-Hubè‡ªå‹•è²¼ä¸Šèˆ‡ä¸Šå‚³è³‡è¨Š</title>
    <link href="../static/css/tailwind.min.css" rel="stylesheet" />
    <script src="../static/js/vue.global.js"></script>
    <script src="../static/js/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      /* å¯ç·¨è¼¯å„²å­˜æ ¼èšç„¦æ¨£å¼ */
      [contenteditable="true"]:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59,130,246,.35);
        background: rgba(59,130,246,.06);
        border-radius: .5rem;
      }
      /* æ²è»¸å¾®å®¢è£½ */
      .nice-scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
      .nice-scrollbar::-webkit-scrollbar-thumb { background: #cfd8e3; border-radius: 9999px; }
      .nice-scrollbar::-webkit-scrollbar-track { background: transparent; }
      @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
      }

      .animate-spin {
          animation: spin 1s linear infinite;
      }
    </style>
  </head>

<body class="min-h-screen p-6 bg-gradient-to-br from-[#fffdf9] via-[#faf6f0] to-[#f3eee8]">
    <div id="app" class="max-w-[1200px] mx-auto">

        <!-- é ‚éƒ¨æ¨™é¡Œ -->
        <div class="bg-gradient-to-r from-blue-50 via-sky-50 to-indigo-50 
                    rounded-2xl shadow-md border border-slate-200 
                    px-6 py-5 mb-6">
        
            <!-- ä¸»æ¨™é¡Œ -->
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800 leading-snug">
                <span class="inline-block align-middle mr-2">ğŸ“‘</span>
                <span class="align-middle">
                [eHUB ASEKH] E-HUB - ä¾›æ‡‰å•†æ‰¿è«¾äº¤æœŸé€šçŸ¥ / Delivery Schedule Notice ä¸Šå‚³è³‡è¨Š
                </span>
            </h1>
            
            <!-- å‰¯æ¨™é¡Œ -->
            <p class="text-slate-600 text-sm mt-2">
                è²¼ä¸Šè³‡æ–™ã€æ¯”å° POã€å¿…è¦æ™‚å°±åœ°ä¿®æ­£ä¸¦è¦†è“‹
            </p>

            <!-- æª”æ¡ˆå‘½åè¦å‰‡æç¤º -->
            <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-md p-3">
                <p class="text-sm text-yellow-800 leading-relaxed">
                ğŸ“Œ <span class="font-semibold">Excel æª”åè¦ç¯„ï¼š</span>
                æª”åæ ¼å¼éœ€ç‚ºï¼š
                <span class="font-mono text-slate-800">
                    sendMailforBadgeMailNoticeApproveESD_yyyymmdd(åŠ ä¸Šæµæ°´è™Ÿå…­ç¢¼)_(Security C).xls
                </span>
                </p>
            </div>
        </div>

      <!-- è²¼ä¸Šå¾Œçš„è‡ªç”±ç·¨è¼¯è¡¨æ ¼ -->
      <div v-if="tableData.length" class="mt-6">
        <div class="bg-white rounded-2xl shadow border border-slate-200 p-4">
          <div class="overflow-auto nice-scrollbar rounded-xl border border-slate-200">
            <table class="min-w-full table-auto text-sm">
              <thead class="sticky top-0 z-10 bg-slate-100/95 backdrop-blur">
                <tr>
                  <th
                    v-for="(h, i) in headers"
                    :key="i"
                    class="px-3 py-2 text-center font-semibold text-slate-700 border-b border-slate-200"
                    v-html="h"
                  ></th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="(row, rowIndex) in tableData"
                  :key="rowIndex"
                  class="odd:bg-slate-50/40"
                >
                  <td
                    v-for="(cell, colIndex) in row"
                    :key="colIndex"
                    class="px-3 py-2 align-top whitespace-pre-wrap break-words border-b border-slate-200"
                  >
                    <div
                      :ref="`cell-${rowIndex}-${colIndex}`"
                      contenteditable="true"
                      class="w-full min-h-[1.5em] outline-none rounded-lg"
                      @focus="currentEditing = { rowIndex, colIndex }"
                      @blur="saveCellContent(rowIndex, colIndex)"
                    >{{ cell }}</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-4 text-right">
            <button
              class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl shadow hover:shadow-md transition"
              @click="submitData"
            >
              <span class="text-lg">ğŸ’¾</span><span>å„²å­˜è³‡æ–™</span>
            </button>
          </div>
        </div>
      </div>

      <!-- ğŸ“¦ PO æ¯”å°çµæœå€å¡Šï¼ˆèˆ‡å…§éƒ¨ä¸€è‡´é¢¨æ ¼ï¼‰ -->
<!-- åœ¨ PO æ¯”å°çµæœå€å¡Šä¸­ä¿®æ”¹ -->
<div class="bg-white/90 backdrop-blur rounded-2xl shadow-md border border-slate-200 px-6 py-5 my-10">
    <h2 class="text-xl md:text-2xl font-bold text-blue-800 leading-snug mb-2 text-center">
        <span class="inline-block mr-2">ğŸ“¦</span>PO æ¯”å°çµæœ
    </h2>
    
    <!-- ä¸€éµè¦†è“‹å…¨éƒ¨æŒ‰éˆ•(åªå°æ­£å¸¸é …ç›®) -->
    <div v-if="allGroups.filter(g => g.type === 'normal').length > 0 && overriddenPoGroups < totalPoGroups" class="text-center mb-4">
        <button
            @click="overrideAllGroups"
            :disabled="isOverridingAll"
            class="bg-red-600 hover:bg-red-700 text-white font-bold px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
        >
            <span v-if="!isOverridingAll">
                <span class="text-lg mr-2">ğŸš€</span>
                ä¸€éµè¦†è“‹å…¨éƒ¨æ­£å¸¸é …ç›® ({{ totalPoGroups - overriddenPoGroups }} çµ„)
            </span>
            <span v-else>
                <span class="text-lg mr-2 animate-spin inline-block">â³</span>
                æ­£åœ¨è¦†è“‹ä¸­... ({{ overriddenPoGroups }}/{{ totalPoGroups }})
            </span>
        </button>
    </div>

    <!-- ä¾ PO No åˆ†çµ„ -->
    <div v-if="allGroups.length">
        <!-- ğŸ†• å€åˆ†æ­£å¸¸é …ç›®å’Œåˆ†æ‰¹é …ç›® -->
        <div
            v-for="group in allGroups"
            :key="group.po_no + '-' + (group.type || 'normal')"  
            class="rounded-xl p-5 mb-6 shadow-md border"
            :class="group.type === 'batch' 
                ? 'border-orange-400 bg-gradient-to-r from-orange-50 to-yellow-50' 
                : group.type === 'merge'
                ? 'border-blue-400 bg-gradient-to-r from-blue-50 to-sky-50'  
                : 'border-slate-200 bg-white/70 backdrop-blur-sm'"
        >
          <!-- åœ¨é¡¯ç¤ºåˆ†æ‰¹é …ç›®çš„éƒ¨åˆ† -->
          <div v-if="group.type === 'batch'" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <span style="font-size: 20px;">ğŸ“„</span>
                  <span style="font-weight: bold; color: #856404;">
                      åˆ†æ‰¹ (å…± {{ group.items.length }} å€‹ Item éœ€è¦èª¿æ•´)
                  </span>
              </div>
              
              <!-- é¡¯ç¤ºæ¯å€‹ Item çš„æ‘˜è¦ -->
              <div style="margin-left: 30px;">
                  <div v-for="(item, idx) in group.items" :key="idx" style="margin-bottom: 8px;">
                      <span style="color: #666;">
                          â€¢ Item {{ item.item }}: XLSæœ‰ <strong style="color: #dc3545;">{{ item.xls_count }}</strong> ç­†,
                          ä½†CSVåªæœ‰ <strong style="color: #28a745;">{{ item.csv_count }}</strong> ç­†
                      </span>
                  </div>
              </div>
              
              <button @click="goToBatchAdjustment(group)" 
                      style="margin-top: 10px; padding: 8px 16px; background: #ffc107; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                  ğŸ“ èª¿æ•´åˆ†æ‰¹
              </button>
          </div>

            <!-- ğŸ†• æ–°å¢:é¡¯ç¤ºåˆä½µé …ç›® -->
            <div v-else-if="group.type === 'merge'" 
                style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">ğŸ”„</span>
                    <span style="font-weight: bold; color: #0369a1;">
                        åˆä½µ ({{ group.items.length }} å€‹ Item éœ€è¦è™•ç†)  <!-- ğŸ‘ˆ é€™è£¡é¡¯ç¤º items æ•¸é‡ -->
                    </span>
                </div>
                
                <!-- é¡¯ç¤ºæ¯å€‹ Item çš„æ‘˜è¦ -->
                <div style="margin-left: 30px;">
                    <div v-for="(item, idx) in group.items" :key="idx" 
                        style="margin-bottom: 8px;">  <!-- ğŸ‘ˆ é€™è£¡æ‰æ˜¯ v-for éæ­· items -->
                        <span style="color: #666;">
                            â€¢ Item {{ item.item }}: CSVæœ‰ <strong style="color: #dc3545;">{{ item.csv_count }}</strong> ç­†åˆ†æ‰¹,
                            XLSåªæœ‰ <strong style="color: #28a745;">{{ item.xls_count }}</strong> ç­† â†’ éœ€è¦åˆä½µ
                        </span>
                    </div>
                </div>
                
                <button @click="goToMergeConfirmation(group)" 
                        style="margin-top: 10px; padding: 8px 16px; background: #0d6efd; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    âœ… ç¢ºèªåˆä½µ
                </button>
            </div>

            <!-- ğŸŸ¢ æ­£å¸¸é …ç›®çš„åŸæœ‰é¡¯ç¤º -->
            <div v-else>
                <h3 class="text-xl font-bold text-blue-700 mb-4">
                    ğŸ“„ PO No: {{ group.po_no }} (å…± {{ group.rows.length }} ç­†)
                </h3>

                <!-- åŸæœ‰çš„è¡¨æ ¼é¡¯ç¤º -->
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm border border-gray-300 border-collapse">
                        <!-- ... åŸæœ‰çš„è¡¨æ ¼å…§å®¹ ... -->
                        <thead>
                            <tr class="bg-blue-50 text-blue-800 text-center">
                                <th class="border border-gray-300 px-2 py-1">ç‹€æ…‹</th>
                                <th class="border border-gray-300 px-2 py-1">Item</th>
                                <th class="border border-gray-300 px-2 py-1">å“å</th>
                                <th class="border border-gray-300 px-2 py-1">äº¤æœŸ</th>
                                <th class="border border-gray-300 px-2 py-1">æ•¸é‡</th>
                                <th class="border border-gray-300 px-2 py-1">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr
                                v-for="(row, idx) in group.rows"
                                :key="idx"
                                class="odd:bg-slate-50 even:bg-white hover:bg-yellow-50 transition-colors"
                            >
                                <!-- åŸæœ‰çš„è¡¨æ ¼è¡Œå…§å®¹ -->
                                <td class="border border-gray-300 px-2 py-1 text-center font-bold align-middle"
                                    :class="row.status.includes('âš ï¸') ? 'text-red-600' : 'text-green-600'">
                                    {{ row.status }}
                                </td>
                                <td class="border border-gray-300 px-2 py-1 align-middle"
                                    :class="{ 'bg-yellow-100 text-red-600 font-bold': row.diff_type === 'item' }">
                                    {{ row.item }}
                                    <span v-if="row.old_item" class="text-xs text-gray-500">(åŸ {{ row.old_item }})</span>
                                </td>
                                <td class="border border-gray-300 px-2 py-1 align-middle"
                                    :class="row.diff_type === 'desc' ? 'bg-red-100 text-red-600 font-bold' : ''">
                                    <span v-if="!row.editing">
                                        {{ row.po_description || row.buyer_description }}
                                    </span>
                                    <input v-else v-model="row.po_description"
                                        class="border border-gray-300 px-1 py-0.5 w-full rounded focus:outline-none focus:ring focus:ring-blue-200"/>
                                </td>
                                <td class="border border-gray-300 px-2 py-1 align-middle">
                                    <span v-if="!row.editing">{{ row.delivery_date }}</span>
                                    <input v-else v-model="row.delivery_date"
                                        class="border border-gray-300 px-1 py-0.5 w-full rounded focus:outline-none focus:ring focus:ring-blue-200"/>
                                </td>
                                <td class="border border-gray-300 px-2 py-1 align-middle">
                                    <span v-if="!row.editing">{{ row.sod_qty }}</span>
                                    <input v-else v-model="row.sod_qty"
                                        class="border border-gray-300 px-1 py-0.5 w-full rounded focus:outline-none focus:ring focus:ring-blue-200"/>
                                </td>
                                <td class="border border-gray-300 px-2 py-1 text-center align-middle">
                                    <template v-if="row.status.includes('âš ï¸')">
                                        <button v-if="!row.editing"
                                            class="px-2 py-1 bg-yellow-400 hover:bg-yellow-500 rounded shadow-sm"
                                            @click="row.editing = true">
                                            âœï¸ æ‰‹å‹•ä¿®æ”¹
                                        </button>
                                        <button v-else
                                            class="px-2 py-1 bg-blue-500 text-white hover:bg-blue-600 rounded shadow-sm"
                                            @click="row.editing = false">
                                            âœ… å®Œæˆ
                                        </button>
                                    </template>
                                    <span v-else class="text-gray-400 italic">âœ“ ç„¡éœ€ä¿®æ”¹</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- è¦†è“‹æŒ‰éˆ• -->
                <div class="mt-4 text-right">
                    <button
                        v-if="!isPoGroupOverridden(group.po_no) && !isOverridingAll"
                        class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
                        @click="saveOverrideGroup(group)"
                    >
                        ğŸ’¾ è¦†è“‹æ­¤çµ„
                    </button>
                    <span v-else-if="isPoGroupOverridden(group.po_no)" class="text-green-600 font-semibold">
                        âœ… å·²å®Œæˆè¦†è“‹
                    </span>
                    <span v-else-if="isOverridingAll" class="text-blue-600 font-semibold">
                        â³ ç­‰å¾…ä¸­...
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç„¡è³‡æ–™ -->
    <div v-else class="text-gray-500 text-center mt-4">
        ç›®å‰æ²’æœ‰æ¯”å°çµæœ,è«‹å…ˆä¸Šå‚³æª”æ¡ˆ
    </div>
</div>


        <!-- åº•éƒ¨å·¥å…·åˆ— -->
        <div class="mt-3 flex items-center justify-between gap-3">
        <input
            type="file"
            ref="fileInput"
            class="hidden"
            accept=".xlsx,.xls,.csv"
            @change="handleFileUpload"
            />
        <!-- è¿”å›ä¸Šä¸€é  -->
        <button
            @click="back_Dashboard"
            class="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 
                hover:from-blue-600 hover:to-blue-700 text-white font-semibold 
                px-5 py-2 rounded-full shadow-md hover:shadow-lg 
                transition-transform transform hover:scale-105"
        >
            <span class="text-lg">ğŸ”™</span>
            <span>è¿”å›ä¸Šä¸€é </span>
        </button>

        <!-- æç¤ºæ–‡å­—ï¼ˆç½®ä¸­ï¼‰ -->
        <div class="text-sm text-slate-700 font-medium text-center flex-1">
            ğŸ“Œ è«‹ç¢ºèªè²¼ä¸Šè³‡æ–™åœ¨ <span class="text-red-500 font-semibold">10 ç­†ä»¥å…§</span>ï¼Œå»ºè­°ä½¿ç”¨ã€Œä¸Šå‚³æª”æ¡ˆã€åŠŸèƒ½ã€‚
        </div>

        <!-- å³å´æŒ‰éˆ•ç¾¤ -->
        <div class="flex gap-3">
            <!-- ä¸Šå‚³æª”æ¡ˆ -->
            <button
                v-show="showUploadButton && (totalPoGroups === 0 || allPoGroupsOverridden)"
                class="flex items-center gap-2 bg-gradient-to-r from-emerald-500 to-emerald-600 
                        hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold 
                        px-5 py-2 rounded-full shadow-md hover:shadow-lg 
                        transition-transform transform hover:scale-105"
                style="background: linear-gradient(to right, #10b981, #059669); color: #fff;"
                @click="$refs.fileInput.click()"
            >
            <span class="text-lg">ğŸ“¤</span>
            <span>ä¸Šå‚³æª”æ¡ˆ (xlsx, csv)</span>
            </button>
        </div>

        </div>
    </div>

    <script src="../static/js/func/eHub.js"></script>
  </body>
</html>
