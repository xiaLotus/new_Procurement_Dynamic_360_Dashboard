### 資訊細項
1. Planned_Purchase_Request_List.csv 預計請購資料表
2. Buyer_detail.csv


    # with lock:
    #     try:
    #         df = pd.read_csv(filepath)
    #         updates = []
    #         for _, row in df.iterrows():
    #             epr_no = str(row.get('E-PR號碼           ', '')).strip()
    #             status = str(row.get('狀態', '')).strip()
    #             stage = str(row.get('簽核中關卡', '')).strip()

    #             if epr_no and epr_no != 'nan':
    #                 updates.append({
    #                     'epr_no': epr_no,
    #                     '狀態': status,
    #                     '簽核中關卡': stage
    #             })
                    
    #         Planned_Purchase_Request_List_df = pd.read_csv(CSV_FILE)
    #         updated_count = 0

    #         for update in updates:
    #             epr = update['epr_no']
    #             status = update['狀態']
    #             stage = update['簽核中關卡']
            
    #             match = Planned_Purchase_Request_List_df['ePR No.'] == int(epr)
    #             if match.any():
    #                 idx = Planned_Purchase_Request_List_df[match].index[0]
    #                 Planned_Purchase_Request_List_df.at[idx, 'Status'] = status
    #                 Planned_Purchase_Request_List_df.at[idx, '簽核中關卡'] = stage
    #                 updated_count += 1
                    
    #         def safe_float_to_int64(val):
    #             try:
    #                 if pd.isna(val):
    #                     return ""
    #                 return str(int(float(val)))
    #             except:
    #                 return str(val).strip()
                
    #         numeric_fields = ["請購順序", "總金額", "需求日", "已開單日期", "ePR No."]
    #         for field in numeric_fields:
    #             if field in Planned_Purchase_Request_List_df.columns:
    #                 Planned_Purchase_Request_List_df[field] = Planned_Purchase_Request_List_df[field].apply(safe_float_to_int64)


    #         Planned_Purchase_Request_List_df.to_csv(CSV_FILE, index=False, encoding='utf-8-sig')
    #         # os.remove(filepath)
    #         return jsonify({'status': 'success', 'updated_count': updated_count})

    #     except Exception as e:
    #         return jsonify({'status': 'Fail', 'reason': e})


    b9f39165-96a1-429d-bb91-9d655bb01f51,V,,1,許銘傑,K22-5F 3400 下貨區夾爪修改,K22-5F 3400 下貨區夾爪改善請購，因天車 MAG 與夾爪間隙約 5 mm，取盒時顎部干涉恐致跳 Die，建議加大墊塊間距降低風險。,19845,20250512,20250626,2506260003,https://khwfap.kh.asegroup.com/ePR/PRQuery/QueryPR?id=2506260003,C3166 代申請,SAP PO 建立完成,,,,,,



📅 目前尚未入帳
2. 必須 epr 與 po no 非空值，有內容才納入計算
3. 扣除 WBS 欄位有值
4. 承諾交期必須在選擇當月
6. 需求日必須要在選擇月份之前
5. 發票月份如果在當月以後則為空值納入計算(比如現在是2025/6，那我發票開在2025/7，這個就需要納入計算了)

舉例：
1. 如果選擇8月，那這邊的入帳條件為，EPR + PO 有數值，扣除 WBS 欄位有值，承諾交期在8月前(如果在8月1號或以後則不納入計算)，發票月份為空值，接下來才把總價加起來
2. 如果選擇7月，那這邊的入帳條件為，EPR + PO 有數值，扣除 WBS 欄位有值，承諾交期在7月前，(7月1號及以後不納入計算)，(發票月份如在7月份後直接變成空值)，接下來才把總價加起來


💰 上月實際入帳
1. 這邊一樣是可以選擇月份
2. 必須 epr 與 po no 非空值，有內容才納入計算
3. 扣除 WBS 欄位有值
4. 發票月份 = 選擇月份
5. 如果選擇月份沒資料，往前找上個月
6. 如果上個月也沒資料，找上上個月
純粹計算已入帳金額

📅 本月尚未入帳 
1. 排除有WBS的項目
2. 必要欄位檢查： ePR No.、PO No.、承諾交期都不能為空
3. 承諾交期 ≤ 選擇月份的前一個月（例如選8月，承諾交期要在7月或之前）
4. 需求日檢查： 如果有需求日，需求日不能在選擇月份或之後
5. 發票月份檢查： 發票月份為空 OR 發票月份 < 選擇月份

最嚴格的條件，用於精確計算本月應該入帳但還沒入帳的項目


📅 本月實際入帳 

1. 排除有WBS的項目
2. 發票月份 = 選擇月份
3. 如果選擇月份沒資料，找上個月
4. 必要欄位檢查： ePR No.、PO No.、承諾交期都不能為空

與上月實際入帳邏輯相同，只是預設月份不同

依照我的要求修改 目前的Rule,記住,一定都要檢查 ePR No.,PO No. 這兩個欄位不得為空

